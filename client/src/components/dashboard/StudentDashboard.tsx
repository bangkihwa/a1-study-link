import React, { useState, useEffect } from 'react';
import StudentLectureView from '../student/StudentLectureView';
import StudentQuestionsView from '../student/StudentQuestionsView';
import ClassBulletinBoard from '../class/ClassBulletinBoard';
import ParentConfirmationModal from '../student/ParentConfirmationModal';
import { loadStudentFeedbacks, loadStudentProgress, loadLectures, loadAssignments, toggleAssignmentComplete } from '../../utils/dataStorage';

interface StudentDashboardProps {
  user: {
    id: number;
    name: string;
    role: string;
  };
  stats?: any;
  recentActivity?: any[];
}

const StudentDashboard: React.FC<StudentDashboardProps> = ({ user, stats, recentActivity }) => {
  const [selectedSubject, setSelectedSubject] = useState<string | null>(null);
  const [currentView, setCurrentView] = useState<'dashboard' | 'lectures' | 'calendar' | 'assignments' | 'bulletin' | 'questions'>('dashboard');
  const [selectedDate, setSelectedDate] = useState<Date>(new Date());
  const [studyHistory, setStudyHistory] = useState<any[]>([]);
  const [feedbacks, setFeedbacks] = useState<any[]>([]);
  const [assignments, setAssignments] = useState<any[]>([]);
  const [studentClasses, setStudentClasses] = useState<any[]>([]);
  const [selectedClass, setSelectedClass] = useState<any>(null);
  const [showParentModal, setShowParentModal] = useState(false);
  const [selectedWeek, setSelectedWeek] = useState<{ start: Date; end: Date } | null>(null);
  const [parentConfirmations, setParentConfirmations] = useState<any[]>([]);

  const handleSubjectClick = (className: string) => {
    const selectedCls = studentClasses.find(c => c.name === className);
    if (selectedCls) {
      setSelectedClass(selectedCls);
      setCurrentView('bulletin');
    }
  };

  const handleQuestionSubmit = () => {
    alert('ÏßàÎ¨∏ÏùÑ Îì±Î°ùÌïòÎäî Í∏∞Îä•ÏùÄ Ï§ÄÎπÑ Ï§ëÏûÖÎãàÎã§.');
  };

  const handleAssignmentView = () => {
    alert('Í≥ºÏ†ú Î™©Î°ùÏùÑ ÌôïÏù∏ÌïòÎäî Í∏∞Îä•ÏùÄ Ï§ÄÎπÑ Ï§ëÏûÖÎãàÎã§.');
  };

  const handleLectureView = () => {
    setCurrentView('lectures');
  };

  useEffect(() => {
    // ÌïôÏäµ Í∏∞Î°ù Î°úÎìú
    const allProgress = loadStudentProgress();
    const studentProgress = allProgress.filter(p => p.studentId === user.id);
    
    // ÌïôÎ∂ÄÎ™® ÌôïÏù∏ Í∏∞Î°ù Î°úÎìú
    const confirmations = JSON.parse(localStorage.getItem('parentConfirmations') || '[]');
    setParentConfirmations(confirmations.filter((c: any) => c.studentId === user.id));
    
    const allFeedbacks = loadStudentFeedbacks();
    const studentFeedbacks = allFeedbacks.filter(f => f.studentId === user.id);
    
    const allAssignments = loadAssignments();
    // ÌïôÏÉùÏù¥ ÏÜçÌïú Î∞òÏùò Í≥ºÏ†úÎßå ÌëúÏãú (Ïó¨Í∏∞ÏÑúÎäî Í∞ÑÎã®ÌïòÍ≤å Î™®Îì† Í≥ºÏ†ú ÌëúÏãú)
    setAssignments(allAssignments);
    
    setStudyHistory(studentProgress);
    setFeedbacks(studentFeedbacks);
    
    // ÌïôÏÉùÏù¥ ÏÜçÌïú Î∞ò Ï†ïÎ≥¥ Î°úÎìú
    const studentsData = localStorage.getItem('students') || localStorage.getItem('studylink_students');
    const classesData = localStorage.getItem('classes') || localStorage.getItem('studylink_classes');
    
    if (classesData) {
      const classes = JSON.parse(classesData);
      const enrolledClasses: any[] = [];
      
      // Î®ºÏ†Ä students Îç∞Ïù¥ÌÑ∞ÏóêÏÑú Ï∞æÍ∏∞
      if (studentsData) {
        const students = JSON.parse(studentsData);
        // ID, username, nameÏúºÎ°ú ÌïôÏÉù Ï∞æÍ∏∞
        const currentStudent = students.find((s: any) => 
          s.id === user.id || 
          s.username === user.username || 
          s.name === user.name ||
          (user.username && s.username === user.username) ||
          (user.name && s.name === user.name)
        );
        
        if (currentStudent) {
          // classIdsÍ∞Ä ÏûàÏúºÎ©¥ Ìï¥Îãπ Î∞ò Ï∞æÍ∏∞
          if (currentStudent.classIds && currentStudent.classIds.length > 0) {
            const classesById = classes.filter((c: any) => 
              currentStudent.classIds.includes(c.id)
            );
            enrolledClasses.push(...classesById);
          }
        }
      }
      
      // classesÏùò students Î∞∞Ïó¥ÏóêÏÑúÎèÑ Ï∞æÍ∏∞
      classes.forEach((cls: any) => {
        // students Î∞∞Ïó¥ Ï≤¥ÌÅ¨
        if (cls.students && Array.isArray(cls.students)) {
          const isEnrolled = cls.students.some((s: any) => 
            s.id === user.id || 
            s.name === user.name ||
            s.username === user.username ||
            (typeof s === 'number' && s === user.id)
          );
          if (isEnrolled && !enrolledClasses.some(c => c.id === cls.id)) {
            enrolledClasses.push(cls);
          }
        }
        
        // studentIds Î∞∞Ïó¥ Ï≤¥ÌÅ¨
        if (cls.studentIds && Array.isArray(cls.studentIds)) {
          const isEnrolled = cls.studentIds.includes(user.id);
          if (isEnrolled && !enrolledClasses.some(c => c.id === cls.id)) {
            enrolledClasses.push(cls);
          }
        }
      });
      
      console.log('Found enrolled classes:', enrolledClasses);
      setStudentClasses(enrolledClasses);
    }
  }, [user.id, user.name, currentView]);

  const getStudyDataForDate = (date: Date) => {
    const dateStr = date.toISOString().split('T')[0];
    const dayStudy = studyHistory.filter(s => 
      s.lastActivity && s.lastActivity.startsWith(dateStr)
    );
    const dayFeedbacks = feedbacks.filter(f => 
      f.completedAt && f.completedAt.startsWith(dateStr)
    );
    return { studies: dayStudy, feedbacks: dayFeedbacks };
  };

  const renderCalendar = () => {
    const year = selectedDate.getFullYear();
    const month = selectedDate.getMonth();
    const firstDay = new Date(year, month, 1);
    const lastDay = new Date(year, month + 1, 0);
    const daysInMonth = lastDay.getDate();
    const startingDayOfWeek = firstDay.getDay();
    
    const monthNames = ['1Ïõî', '2Ïõî', '3Ïõî', '4Ïõî', '5Ïõî', '6Ïõî', '7Ïõî', '8Ïõî', '9Ïõî', '10Ïõî', '11Ïõî', '12Ïõî'];
    const days = [];
    
    // Ï£ºÍ∞Ñ ÌôïÏù∏ Ïó¨Î∂Ä Ï≤¥ÌÅ¨ Ìï®Ïàò
    const isWeekConfirmed = (date: Date) => {
      const weekStart = new Date(date);
      weekStart.setDate(date.getDate() - date.getDay());
      return parentConfirmations.some((conf: any) => {
        const confWeekStart = new Date(conf.weekStart);
        return confWeekStart.toDateString() === weekStart.toDateString();
      });
    };
    
    // Îπà Ïπ∏ Ï∂îÍ∞Ä
    for (let i = 0; i < startingDayOfWeek; i++) {
      days.push(<div key={`empty-${i}`} style={{ padding: '0.5rem' }}></div>);
    }
    
    // ÎÇ†Ïßú Ï∂îÍ∞Ä
    for (let day = 1; day <= daysInMonth; day++) {
      const date = new Date(year, month, day);
      const dayData = getStudyDataForDate(date);
      const hasStudy = dayData.studies.length > 0 || dayData.feedbacks.length > 0;
      const isSunday = date.getDay() === 0;
      const weekConfirmed = isWeekConfirmed(date);
      
      days.push(
        <div
          key={day}
          onClick={() => {
            if (hasStudy) {
              const lectures = loadLectures();
              let message = `üìÖ ${year}ÎÖÑ ${month + 1}Ïõî ${day}Ïùº ÌïôÏäµ Í∏∞Î°ù\n\n`;
              
              dayData.studies.forEach(study => {
                const lecture = lectures.find(l => l.id === study.lectureId);
                if (lecture) {
                  message += `üìö ${lecture.title}\n`;
                  message += `   - ÌïôÏäµÏãúÍ∞Ñ: ${study.studyTime}Î∂Ñ\n`;
                  message += `   - ÏôÑÎ£å Î∏îÎ°ù: ${study.completedBlocks.length}Í∞ú\n\n`;
                }
              });
              
              dayData.feedbacks.forEach(feedback => {
                message += `üí¨ ${feedback.lectureTitle} ÌîºÎìúÎ∞±\n`;
                message += `   - ÎÇúÏù¥ÎèÑ: ${feedback.difficulty === 'too_easy' ? 'Ïâ¨ÏõÄ' : feedback.difficulty === 'just_right' ? 'Ï†ÅÎãπÌï®' : 'Ïñ¥Î†§ÏõÄ'}\n`;
                message += `   - Ïù¥Ìï¥ÎèÑ: ${feedback.understanding === 'excellent' ? 'Îß§Ïö∞ Ï¢ãÏùå' : feedback.understanding === 'good' ? 'Ï¢ãÏùå' : feedback.understanding === 'fair' ? 'Î≥¥ÌÜµ' : 'Î∂ÄÏ°±'}\n`;
                if (feedback.question) {
                  message += `   - ÏßàÎ¨∏: ${feedback.question}\n`;
                  if (feedback.answer) {
                    message += `   - ÎãµÎ≥Ä: ${feedback.answer}\n`;
                  }
                }
                message += '\n';
              });
              
              alert(message);
            }
          }}
          style={{
            padding: '0.5rem',
            border: '1px solid #e5e7eb',
            borderRadius: '0.375rem',
            cursor: hasStudy ? 'pointer' : 'default',
            background: hasStudy ? '#dcfce7' : 'white',
            minHeight: '60px',
            display: 'flex',
            flexDirection: 'column',
            alignItems: 'center',
            justifyContent: 'center',
            position: 'relative'
          }}
        >
          <div style={{ fontWeight: '500' }}>{day}</div>
          {hasStudy && (
            <div style={{ fontSize: '0.75rem', color: '#16a34a', marginTop: '0.25rem' }}>
              ‚úÖ ÌïôÏäµÏôÑÎ£å
            </div>
          )}
          {isSunday && weekConfirmed && (
            <div style={{ 
              position: 'absolute', 
              top: '2px', 
              right: '2px',
              fontSize: '0.7rem',
              backgroundColor: '#fbbf24',
              color: 'white',
              padding: '1px 4px',
              borderRadius: '3px',
              fontWeight: 'bold'
            }}>
              ÌôïÏù∏Îê®
            </div>
          )}
        </div>
      );
    }
    
    return (
      <div>
        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '1rem' }}>
          <button 
            onClick={() => setSelectedDate(new Date(year, month - 1))}
            className="btn btn-secondary"
            style={{ padding: '0.5rem 1rem' }}
          >
            ‚Üê
          </button>
          <h3 style={{ fontSize: '1.25rem', fontWeight: '600' }}>
            {year}ÎÖÑ {monthNames[month]}
          </h3>
          <button 
            onClick={() => setSelectedDate(new Date(year, month + 1))}
            className="btn btn-secondary"
            style={{ padding: '0.5rem 1rem' }}
          >
            ‚Üí
          </button>
        </div>
        <div style={{ display: 'grid', gridTemplateColumns: 'repeat(7, 1fr)', gap: '0.5rem', marginBottom: '0.5rem' }}>
          <div style={{ textAlign: 'center', fontWeight: '600', fontSize: '0.875rem' }}>Ïùº</div>
          <div style={{ textAlign: 'center', fontWeight: '600', fontSize: '0.875rem' }}>Ïõî</div>
          <div style={{ textAlign: 'center', fontWeight: '600', fontSize: '0.875rem' }}>Ìôî</div>
          <div style={{ textAlign: 'center', fontWeight: '600', fontSize: '0.875rem' }}>Ïàò</div>
          <div style={{ textAlign: 'center', fontWeight: '600', fontSize: '0.875rem' }}>Î™©</div>
          <div style={{ textAlign: 'center', fontWeight: '600', fontSize: '0.875rem' }}>Í∏à</div>
          <div style={{ textAlign: 'center', fontWeight: '600', fontSize: '0.875rem' }}>ÌÜ†</div>
        </div>
        <div style={{ display: 'grid', gridTemplateColumns: 'repeat(7, 1fr)', gap: '0.5rem' }}>
          {days}
        </div>
      </div>
    );
  };



  if (currentView === 'lectures') {
    return <StudentLectureView onBack={() => setCurrentView('dashboard')} studentId={user.id} />;
  }

  if (currentView === 'questions') {
    return <StudentQuestionsView 
      studentId={user.id} 
      studentName={user.name}
      onBack={() => setCurrentView('dashboard')} 
    />;
  }

  if (currentView === 'bulletin' && selectedClass) {
    return (
      <ClassBulletinBoard 
        classId={selectedClass.id}
        className={selectedClass.name}
        userRole="student"
        userId={user.id}
        userName={user.name}
        onBack={() => {
          setCurrentView('dashboard');
          setSelectedClass(null);
        }}
      />
    );
  }

  if (currentView === 'calendar') {
    return (
      <div>
        <div style={{ marginBottom: '2rem', display: 'flex', alignItems: 'center', gap: '1rem', justifyContent: 'space-between' }}>
          <div style={{ display: 'flex', alignItems: 'center', gap: '1rem' }}>
            <button 
              onClick={() => setCurrentView('dashboard')} 
              className="btn btn-secondary"
            >
              ‚Üê Îí§Î°ú
            </button>
            <h2 style={{ margin: 0, fontSize: '1.5rem', fontWeight: 'bold' }}>
              üìÖ ÌïôÏäµ Îã¨Î†•
            </h2>
          </div>
          <button
            onClick={() => {
              const today = new Date();
              const weekStart = new Date(today);
              weekStart.setDate(today.getDate() - today.getDay());
              const weekEnd = new Date(weekStart);
              weekEnd.setDate(weekStart.getDate() + 6);
              setSelectedWeek({ start: weekStart, end: weekEnd });
              setShowParentModal(true);
            }}
            style={{
              padding: '0.75rem 1.5rem',
              backgroundColor: '#10b981',
              color: 'white',
              border: 'none',
              borderRadius: '6px',
              cursor: 'pointer',
              fontSize: '0.875rem',
              fontWeight: '500',
              display: 'flex',
              alignItems: 'center',
              gap: '0.5rem'
            }}
          >
            ‚úÖ Ï£ºÍ∞Ñ ÌïôÎ∂ÄÎ™® ÌôïÏù∏
          </button>
        </div>
        <div className="card">
          <div className="card-body">
            {renderCalendar()}
          </div>
        </div>
        {showParentModal && selectedWeek && (
          <ParentConfirmationModal
            isOpen={showParentModal}
            onClose={() => {
              setShowParentModal(false);
              setSelectedWeek(null);
            }}
            weekStart={selectedWeek.start}
            weekEnd={selectedWeek.end}
            studentId={user.id}
            studentName={user.name}
            onConfirm={(password, comment) => {
              const confirmations = JSON.parse(localStorage.getItem('parentConfirmations') || '[]');
              confirmations.push({
                studentId: user.id,
                studentName: user.name,
                weekStart: selectedWeek.start.toISOString(),
                weekEnd: selectedWeek.end.toISOString(),
                confirmedAt: new Date().toISOString(),
                comment: comment
              });
              localStorage.setItem('parentConfirmations', JSON.stringify(confirmations));
              setParentConfirmations(confirmations.filter((c: any) => c.studentId === user.id));
              alert('ÌïôÎ∂ÄÎ™® ÌôïÏù∏Ïù¥ ÏôÑÎ£åÎêòÏóàÏäµÎãàÎã§.');
              setShowParentModal(false);
              setSelectedWeek(null);
            }}
          />
        )}
      </div>
    );
  }

  if (currentView === 'assignments') {
    return (
      <div>
        <div style={{ marginBottom: '2rem', display: 'flex', alignItems: 'center', gap: '1rem' }}>
          <button 
            onClick={() => setCurrentView('dashboard')} 
            className="btn btn-secondary"
          >
            ‚Üê Îí§Î°ú
          </button>
          <h2 style={{ margin: 0, fontSize: '1.5rem', fontWeight: 'bold' }}>
            üìù Í≥ºÏ†ú Í¥ÄÎ¶¨
          </h2>
        </div>
        
        <div className="grid grid-1" style={{ gap: '1rem' }}>
          {assignments.length === 0 ? (
            <div className="card">
              <div className="card-body" style={{ textAlign: 'center', padding: '3rem' }}>
                <div style={{ fontSize: '3rem', marginBottom: '1rem' }}>üìù</div>
                <p style={{ color: '#6b7280' }}>ÌòÑÏû¨ Î∞∞Î∂ÄÎêú Í≥ºÏ†úÍ∞Ä ÏóÜÏäµÎãàÎã§.</p>
              </div>
            </div>
          ) : (
            assignments.map(assignment => {
              const isCompleted = assignment.completedStudents?.includes(user.id);
              const dueDate = new Date(assignment.dueDate);
              const today = new Date();
              const isOverdue = dueDate < today && !isCompleted;
              
              return (
                <div key={assignment.id} className="card">
                  <div className="card-body">
                    <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'start' }}>
                      <div style={{ flex: 1 }}>
                        <h3 style={{ fontSize: '1.25rem', fontWeight: '600', marginBottom: '0.5rem' }}>
                          {assignment.title}
                        </h3>
                        <p style={{ color: '#6b7280', marginBottom: '0.5rem' }}>
                          {assignment.description}
                        </p>
                        <div style={{ display: 'flex', gap: '1rem', flexWrap: 'wrap', marginBottom: '1rem' }}>
                          <span style={{
                            background: '#dbeafe',
                            color: '#1e40af',
                            padding: '0.25rem 0.75rem',
                            borderRadius: '9999px',
                            fontSize: '0.875rem'
                          }}>
                            üè´ {assignment.className}
                          </span>
                          <span style={{
                            background: '#e0e7ff',
                            color: '#4338ca',
                            padding: '0.25rem 0.75rem',
                            borderRadius: '9999px',
                            fontSize: '0.875rem'
                          }}>
                            üë®‚Äçüè´ {assignment.teacherName}
                          </span>
                          <span style={{
                            background: isOverdue ? '#fee2e2' : '#fef3c7',
                            color: isOverdue ? '#dc2626' : '#d97706',
                            padding: '0.25rem 0.75rem',
                            borderRadius: '9999px',
                            fontSize: '0.875rem'
                          }}>
                            üìÖ ÎßàÍ∞ê: {dueDate.toLocaleDateString()}
                          </span>
                        </div>
                      </div>
                      <div style={{ display: 'flex', flexDirection: 'column', alignItems: 'center', gap: '0.5rem' }}>
                        <button
                          onClick={() => {
                            toggleAssignmentComplete(assignment.id, user.id);
                            setAssignments(loadAssignments());
                          }}
                          className={isCompleted ? "btn btn-success" : "btn btn-secondary"}
                          style={{
                            padding: '0.5rem 1rem',
                            fontSize: '0.875rem'
                          }}
                        >
                          {isCompleted ? '‚úÖ ÏôÑÎ£åÎê®' : '‚¨ú ÎØ∏ÏôÑÎ£å'}
                        </button>
                        {isCompleted && (
                          <span style={{ fontSize: '0.75rem', color: '#16a34a' }}>
                            Í≥ºÏ†ú ÏôÑÎ£å!
                          </span>
                        )}
                      </div>
                    </div>
                  </div>
                </div>
              );
            })
          )}
        </div>
      </div>
    );
  }

  return (
    <div>
      <div style={{ marginBottom: '2rem' }}>
        <h1 style={{ fontSize: '2rem', fontWeight: 'bold', color: '#1f2937', marginBottom: '0.5rem' }}>
          ÏïàÎÖïÌïòÏÑ∏Ïöî, {user.name}Îãò! üéì
        </h1>
        <p style={{ color: '#6b7280', fontSize: '1.125rem' }}>
          Ïò§ÎäòÎèÑ Ïó¥Ïã¨Ìûà Í≥µÎ∂ÄÌï¥Î¥êÏöî!
        </p>
      </div>

      {/* ÌÉ≠ ÎÑ§ÎπÑÍ≤åÏù¥ÏÖò */}
      <div style={{ 
        display: 'flex', 
        gap: '1rem', 
        marginBottom: '2rem',
        borderBottom: '1px solid #e5e7eb',
        paddingBottom: '0.5rem'
      }}>
        <button
          onClick={() => setCurrentView('dashboard')}
          style={{
            padding: '0.75rem 1.5rem',
            border: 'none',
            background: currentView === 'dashboard' ? '#667eea' : 'transparent',
            color: currentView === 'dashboard' ? 'white' : '#6b7280',
            borderRadius: '0.375rem',
            fontWeight: '500',
            cursor: 'pointer',
            transition: 'all 0.2s ease'
          }}
        >
          üìä ÎåÄÏãúÎ≥¥Îìú
        </button>
        <button
          onClick={() => setCurrentView('calendar')}
          style={{
            padding: '0.75rem 1.5rem',
            border: 'none',
            background: currentView === 'calendar' ? '#667eea' : 'transparent',
            color: currentView === 'calendar' ? 'white' : '#6b7280',
            borderRadius: '0.375rem',
            fontWeight: '500',
            cursor: 'pointer',
            transition: 'all 0.2s ease'
          }}
        >
          üìÖ ÌïôÏäµ Îã¨Î†•
        </button>
        <button
          onClick={() => setCurrentView('assignments')}
          style={{
            padding: '0.75rem 1.5rem',
            border: 'none',
            background: currentView === 'assignments' ? '#667eea' : 'transparent',
            color: currentView === 'assignments' ? 'white' : '#6b7280',
            borderRadius: '0.375rem',
            fontWeight: '500',
            cursor: 'pointer',
            transition: 'all 0.2s ease'
          }}
        >
          üìù Í≥ºÏ†ú Í¥ÄÎ¶¨
        </button>
        <button
          onClick={() => setCurrentView('lectures')}
          style={{
            padding: '0.75rem 1.5rem',
            border: 'none',
            background: currentView === 'lectures' ? '#667eea' : 'transparent',
            color: currentView === 'lectures' ? 'white' : '#6b7280',
            borderRadius: '0.375rem',
            fontWeight: '500',
            cursor: 'pointer',
            transition: 'all 0.2s ease'
          }}
        >
          üìö ÎÇ¥ Í∞ïÏùò
        </button>
      </div>

      {/* ÌïôÏäµ ÌòÑÌô© Ïπ¥ÎìúÎì§ */}
      <div className="grid grid-4" style={{ gap: '1.5rem', marginBottom: '2rem' }}>
        <div 
          className="card"
          style={{ cursor: 'pointer', transition: 'transform 0.2s ease' }}
          onClick={handleLectureView}
          onMouseEnter={(e) => e.currentTarget.style.transform = 'translateY(-2px)'}
          onMouseLeave={(e) => e.currentTarget.style.transform = 'translateY(0px)'}
        >
          <div className="card-body">
            <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between' }}>
              <div>
                <p style={{ color: '#6b7280', fontSize: '0.875rem', marginBottom: '0.5rem' }}>ÏàòÍ∞ï Ï§ë Í∞ïÏùò</p>
                <p style={{ fontSize: '2rem', fontWeight: 'bold', color: '#2563eb' }}>
                  {(() => {
                    const lectures = loadLectures();
                    const progress = loadStudentProgress();
                    const completedIds = progress
                      .filter(p => p.studentId === user.id && p.completedBlocks.length === lectures.find(l => l.id === p.lectureId)?.contentBlocks?.length)
                      .map(p => p.lectureId);
                    return lectures.filter(l => l.isPublished && !completedIds.includes(l.id)).length;
                  })()}
                </p>
              </div>
              <div style={{ fontSize: '2rem' }}>üìö</div>
            </div>
          </div>
        </div>

        <div className="card">
          <div className="card-body">
            <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between' }}>
              <div>
                <p style={{ color: '#6b7280', fontSize: '0.875rem', marginBottom: '0.5rem' }}>ÏôÑÎ£å Í∞ïÏùò</p>
                <p style={{ fontSize: '2rem', fontWeight: 'bold', color: '#16a34a' }}>
                  {(() => {
                    const lectures = loadLectures();
                    const progress = loadStudentProgress();
                    return progress.filter(p => {
                      if (p.studentId !== user.id) return false;
                      const lecture = lectures.find(l => l.id === p.lectureId);
                      return lecture && p.completedBlocks.length === lecture.contentBlocks.length;
                    }).length;
                  })()}
                </p>
              </div>
              <div style={{ fontSize: '2rem' }}>‚úÖ</div>
            </div>
          </div>
        </div>

        <div 
          className="card"
          style={{ cursor: 'pointer', transition: 'transform 0.2s ease' }}
          onClick={() => setCurrentView('assignments')}
          onMouseEnter={(e) => e.currentTarget.style.transform = 'translateY(-2px)'}
          onMouseLeave={(e) => e.currentTarget.style.transform = 'translateY(0px)'}
        >
          <div className="card-body">
            <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between' }}>
              <div>
                <p style={{ color: '#6b7280', fontSize: '0.875rem', marginBottom: '0.5rem' }}>ÎØ∏ÏôÑÎ£å Í≥ºÏ†ú</p>
                <p style={{ fontSize: '2rem', fontWeight: 'bold', color: '#dc2626' }}>
                  {assignments.filter(a => !a.completedStudents?.includes(user.id)).length}
                </p>
              </div>
              <div style={{ fontSize: '2rem' }}>üìù</div>
            </div>
          </div>
        </div>

        <div 
          className="card"
          style={{ cursor: 'pointer', transition: 'transform 0.2s ease' }}
          onClick={() => setCurrentView('questions')}
          onMouseEnter={(e) => e.currentTarget.style.transform = 'translateY(-2px)'}
          onMouseLeave={(e) => e.currentTarget.style.transform = 'translateY(0px)'}
        >
          <div className="card-body">
            <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between' }}>
              <div>
                <p style={{ color: '#6b7280', fontSize: '0.875rem', marginBottom: '0.5rem' }}>ÎÇ¥ ÏßàÎ¨∏</p>
                <div style={{ display: 'flex', gap: '1rem', alignItems: 'baseline' }}>
                  <div>
                    <p style={{ fontSize: '1.5rem', fontWeight: 'bold', color: '#16a34a', marginBottom: '0' }}>
                      {(() => {
                        const teacherQuestions = JSON.parse(localStorage.getItem('teacherQuestions') || '[]');
                        return teacherQuestions.filter(
                          (q: any) => q.studentId === user.id && q.isAnswered
                        ).length;
                      })()}
                    </p>
                    <p style={{ fontSize: '0.75rem', color: '#16a34a' }}>ÎãµÎ≥ÄÏôÑÎ£å</p>
                  </div>
                  <div>
                    <p style={{ fontSize: '1.5rem', fontWeight: 'bold', color: '#d97706', marginBottom: '0' }}>
                      {(() => {
                        const teacherQuestions = JSON.parse(localStorage.getItem('teacherQuestions') || '[]');
                        return teacherQuestions.filter(
                          (q: any) => q.studentId === user.id && !q.isAnswered
                        ).length;
                      })()}
                    </p>
                    <p style={{ fontSize: '0.75rem', color: '#d97706' }}>ÎãµÎ≥ÄÎåÄÍ∏∞</p>
                  </div>
                </div>
              </div>
              <div style={{ fontSize: '2rem' }}>‚ùì</div>
            </div>
          </div>
        </div>
      </div>

      {/* ÏµúÍ∑º ÌôúÎèô Î∞è ÏàòÍ∞ï Í≥ºÎ™© */}
      <div className="grid grid-2" style={{ gap: '2rem' }}>
        <div className="card">
          <div className="card-header">
            <div className="card-title">üìö ÏµúÍ∑º ÌôúÎèô</div>
          </div>
          <div className="card-body">
            <div style={{ display: 'flex', flexDirection: 'column', gap: '1rem' }}>
              {(() => {
                // Ïã§Ï†ú ÏµúÍ∑º ÌôúÎèô Í∞ÄÏ†∏Ïò§Í∏∞
                const activities: any[] = [];
                
                // ÌïôÏäµ ÏßÑÎèÑ ÌôúÎèô
                const progress = loadStudentProgress();
                const myProgress = progress.filter(p => p.studentId === user.id)
                  .sort((a, b) => new Date(b.lastActivity || 0).getTime() - new Date(a.lastActivity || 0).getTime())
                  .slice(0, 2);
                
                myProgress.forEach(p => {
                  const lectures = loadLectures();
                  const lecture = lectures.find(l => l.id === p.lectureId);
                  if (lecture) {
                    activities.push({
                      type: 'lecture',
                      title: `${lecture.title} ÌïôÏäµ`,
                      date: p.lastActivity || new Date().toISOString(),
                      icon: 'üìö'
                    });
                  }
                });
                
                // ÏßàÎ¨∏ ÌôúÎèô Î∞è ÎãµÎ≥Ä Î∞õÏùÄ ÌôúÎèô
                const questions = JSON.parse(localStorage.getItem('teacherQuestions') || '[]');
                const myQuestions = questions.filter((q: any) => q.studentId === user.id)
                  .sort((a: any, b: any) => new Date(b.createdAt).getTime() - new Date(a.createdAt).getTime())
                  .slice(0, 3);
                
                myQuestions.forEach((q: any) => {
                  if (q.isAnswered && q.answer) {
                    // ÎãµÎ≥Ä Î∞õÏùÄ ÌôúÎèô
                    activities.push({
                      type: 'answer',
                      title: `"${q.question.substring(0, 20)}..."Ïóê ÎåÄÌïú ÎãµÎ≥Ä ÎèÑÏ∞©`,
                      date: q.answeredAt || q.createdAt,
                      icon: '‚úÖ'
                    });
                  } else {
                    // ÏßàÎ¨∏Ìïú ÌôúÎèô
                    activities.push({
                      type: 'question',
                      title: q.question.substring(0, 30) + (q.question.length > 30 ? '...' : ''),
                      date: q.createdAt,
                      icon: '‚ùì'
                    });
                  }
                });
                
                // Í≥ºÏ†ú ÌôúÎèô
                const assignments = loadAssignments();
                const completedAssignments = assignments.filter(a => 
                  a.completedStudents?.includes(user.id)
                ).slice(0, 1);
                
                completedAssignments.forEach(a => {
                  activities.push({
                    type: 'assignment',
                    title: `${a.title} Ï†úÏ∂ú`,
                    date: a.dueDate,
                    icon: 'üìù'
                  });
                });
                
                // ÎÇ†ÏßúÏàú Ï†ïÎ†¨ ÌõÑ ÏµúÍ∑º 3Í∞úÎßå
                const sortedActivities = activities
                  .sort((a, b) => new Date(b.date).getTime() - new Date(a.date).getTime())
                  .slice(0, 3);
                
                if (sortedActivities.length > 0) {
                  return sortedActivities.map((activity, index) => (
                    <div key={index} style={{ display: 'flex', alignItems: 'center', gap: '0.75rem', padding: '1rem', background: '#f8fafc', borderRadius: '0.5rem' }}>
                      <div style={{ fontSize: '1.5rem' }}>
                        {activity.icon}
                      </div>
                      <div>
                        <p style={{ fontWeight: '500', marginBottom: '0.25rem' }}>{activity.title}</p>
                        <p style={{ color: '#6b7280', fontSize: '0.875rem' }}>
                          {(() => {
                            const date = new Date(activity.date);
                            const now = new Date();
                            const diffMs = now.getTime() - date.getTime();
                            const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
                            const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
                            
                            if (diffHours < 1) return 'Î∞©Í∏à Ï†Ñ';
                            if (diffHours < 24) return `${diffHours}ÏãúÍ∞Ñ Ï†Ñ`;
                            if (diffDays < 7) return `${diffDays}Ïùº Ï†Ñ`;
                            return date.toLocaleDateString();
                          })()}
                        </p>
                      </div>
                    </div>
                  ));
                }
                
                // Í∏∞Î≥∏ Îç∞Î™® Îç∞Ïù¥ÌÑ∞
                return (
                  <>
                  <div style={{ display: 'flex', alignItems: 'center', gap: '0.75rem', padding: '1rem', background: '#f0fdf4', borderRadius: '0.5rem' }}>
                    <div style={{ fontSize: '1.5rem' }}>üìö</div>
                    <div>
                      <p style={{ fontWeight: '500', marginBottom: '0.25rem' }}>Ï§ëÎì±3 Î¨ºÎ¶¨ - ÌûòÍ≥º Ïö¥Îèô</p>
                      <p style={{ color: '#6b7280', fontSize: '0.875rem' }}>Ïò§Îäò ÏôÑÎ£å</p>
                    </div>
                  </div>

                  <div style={{ display: 'flex', alignItems: 'center', gap: '0.75rem', padding: '1rem', background: '#fef3c7', borderRadius: '0.5rem' }}>
                    <div style={{ fontSize: '1.5rem' }}>‚ùì</div>
                    <div>
                      <p style={{ fontWeight: '500', marginBottom: '0.25rem' }}>ÏÜçÎèÑÏôÄ Í∞ÄÏÜçÎèÑÏùò Ï∞®Ïù¥Ï†êÏùÄ?</p>
                      <p style={{ color: '#6b7280', fontSize: '0.875rem' }}>1ÏãúÍ∞Ñ Ï†Ñ ÏßàÎ¨∏</p>
                    </div>
                  </div>

                  <div style={{ display: 'flex', alignItems: 'center', gap: '0.75rem', padding: '1rem', background: '#dbeafe', borderRadius: '0.5rem' }}>
                    <div style={{ fontSize: '1.5rem' }}>üìù</div>
                    <div>
                      <p style={{ fontWeight: '500', marginBottom: '0.25rem' }}>Î¨ºÎ¶¨ Î¨∏Ï†úÏßë 1-10Î≤à</p>
                      <p style={{ color: '#6b7280', fontSize: '0.875rem' }}>2ÏãúÍ∞Ñ Ï†Ñ Ï†úÏ∂ú</p>
                    </div>
                  </div>
                </>
                );
              })()}
            </div>
          </div>
        </div>

        <div className="card">
          <div className="card-header">
            <div className="card-title">üéØ ÏàòÍ∞ï Í≥ºÎ™©</div>
          </div>
          <div className="card-body">
            <div style={{ display: 'flex', flexDirection: 'column', gap: '1rem' }}>
              {studentClasses.length > 0 ? (
                studentClasses.map((cls: any) => (
                  <div
                    key={cls.id}
                    style={{ 
                      padding: '1rem', 
                      border: '1px solid #e5e7eb', 
                      borderRadius: '0.5rem',
                      cursor: 'pointer',
                      transition: 'all 0.2s ease'
                    }}
                    onClick={() => handleSubjectClick(cls.name)}
                    onMouseEnter={(e) => {
                      e.currentTarget.style.borderColor = '#667eea';
                      e.currentTarget.style.transform = 'translateY(-2px)';
                      e.currentTarget.style.boxShadow = '0 4px 12px rgba(102, 126, 234, 0.15)';
                    }}
                    onMouseLeave={(e) => {
                      e.currentTarget.style.borderColor = '#e5e7eb';
                      e.currentTarget.style.transform = 'translateY(0px)';
                      e.currentTarget.style.boxShadow = 'none';
                    }}
                  >
                    <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '0.5rem' }}>
                      <h3 style={{ fontWeight: '600' }}>{cls.name}</h3>
                      <span style={{ fontSize: '1.5rem' }}>
                        {cls.subject === 'Î¨ºÎ¶¨' ? '‚ö°' : cls.subject === 'ÌôîÌïô' ? 'üß™' : cls.subject === 'ÏÉùÎ¨º' ? 'üß¨' : 'üìö'}
                      </span>
                    </div>
                    <p style={{ color: '#6b7280', fontSize: '0.875rem', marginBottom: '0.75rem' }}>
                      Îã¥ÎãπÍµêÏÇ¨: {cls.teacherNames ? cls.teacherNames.join(', ') : 'ÎØ∏Î∞∞Ï†ï'}
                    </p>
                    {cls.schedule && (
                      <p style={{ color: '#6b7280', fontSize: '0.875rem', marginBottom: '0.75rem' }}>
                        ÏàòÏóÖÏãúÍ∞Ñ: {cls.schedule}
                      </p>
                    )}
                    <div style={{ background: '#f3f4f6', borderRadius: '9999px', height: '8px', marginBottom: '0.5rem' }}>
                      <div style={{ 
                        background: '#16a34a', 
                        width: `${Math.floor(Math.random() * 40) + 50}%`, 
                        height: '8px', 
                        borderRadius: '9999px' 
                      }}></div>
                    </div>
                    <p style={{ fontSize: '0.875rem', color: '#16a34a' }}>
                      ÏßÑÎèÑÏú®: {Math.floor(Math.random() * 40) + 50}%
                    </p>
                  </div>
                ))
              ) : (
                <div 
                style={{ 
                  padding: '1rem', 
                  border: '1px solid #e5e7eb', 
                  borderRadius: '0.5rem',
                  cursor: 'pointer',
                  transition: 'all 0.2s ease'
                }}
                onClick={() => handleSubjectClick('Ï§ëÎì±3 Î¨ºÎ¶¨AÎ∞ò')}
                onMouseEnter={(e) => {
                  e.currentTarget.style.borderColor = '#667eea';
                  e.currentTarget.style.transform = 'translateY(-2px)';
                  e.currentTarget.style.boxShadow = '0 4px 12px rgba(102, 126, 234, 0.15)';
                }}
                onMouseLeave={(e) => {
                  e.currentTarget.style.borderColor = '#e5e7eb';
                  e.currentTarget.style.transform = 'translateY(0px)';
                  e.currentTarget.style.boxShadow = 'none';
                }}
              >
                <div style={{ 
                  padding: '2rem',
                  textAlign: 'center',
                  color: '#6b7280'
                }}>
                  <p>ÏàòÍ∞ï Ï§ëÏù∏ Í≥ºÎ™©Ïù¥ ÏóÜÏäµÎãàÎã§.</p>
                  <p style={{ fontSize: '0.875rem', marginTop: '0.5rem' }}>Í¥ÄÎ¶¨ÏûêÏóêÍ≤å Î¨∏ÏùòÌï¥Ï£ºÏÑ∏Ïöî.</p>
                </div>
              </div>
              )}
            </div>
          </div>
        </div>
      </div>

      {/* ÏôÑÎ£åÌïú Í∞ïÏùò Î™©Î°ù */}
      <div className="card" style={{ marginTop: '2rem' }}>
        <div className="card-header">
          <div className="card-title">‚úÖ ÏôÑÎ£åÌïú Í∞ïÏùò</div>
        </div>
        <div className="card-body">
          {(() => {
            const lectures = loadLectures();
            const progress = loadStudentProgress();
            const completedLectures = lectures.filter(l => {
              const p = progress.find((prog: any) => 
                prog.studentId === user.id && prog.lectureId === l.id
              );
              return p && p.completedBlocks && l.contentBlocks && 
                     p.completedBlocks.length === l.contentBlocks.length;
            });

            if (completedLectures.length === 0) {
              return (
                <p style={{ textAlign: 'center', color: '#6b7280', padding: '2rem' }}>
                  ÏïÑÏßÅ ÏôÑÎ£åÌïú Í∞ïÏùòÍ∞Ä ÏóÜÏäµÎãàÎã§.
                </p>
              );
            }

            return (
              <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fill, minmax(250px, 1fr))', gap: '1rem' }}>
                {completedLectures.map(lecture => {
                  const p = progress.find((prog: any) => 
                    prog.studentId === user.id && prog.lectureId === lecture.id
                  );
                  return (
                    <div 
                      key={lecture.id}
                      style={{
                        padding: '1rem',
                        border: '1px solid #e5e7eb',
                        borderRadius: '0.5rem',
                        background: '#f0fdf4',
                        cursor: 'pointer',
                        transition: 'all 0.2s ease'
                      }}
                      onClick={() => alert(`${lecture.title} Í∞ïÏùòÎ•º Îã§Ïãú Î≥¥ÏãúÎ†§Î©¥ 'ÎÇ¥ Í∞ïÏùò' Î©îÎâ¥Î•º Ïù¥Ïö©Ìï¥Ï£ºÏÑ∏Ïöî.`)}
                      onMouseEnter={(e) => {
                        e.currentTarget.style.transform = 'translateY(-2px)';
                        e.currentTarget.style.boxShadow = '0 4px 12px rgba(0,0,0,0.1)';
                      }}
                      onMouseLeave={(e) => {
                        e.currentTarget.style.transform = 'translateY(0)';
                        e.currentTarget.style.boxShadow = 'none';
                      }}
                    >
                      <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'start', marginBottom: '0.5rem' }}>
                        <h4 style={{ fontSize: '1rem', fontWeight: '600', margin: 0 }}>{lecture.title}</h4>
                        <span style={{ fontSize: '1.25rem' }}>üèÜ</span>
                      </div>
                      <p style={{ fontSize: '0.875rem', color: '#6b7280', marginBottom: '0.5rem' }}>
                        {lecture.subject} ‚Ä¢ {lecture.duration}Î∂Ñ
                      </p>
                      {p && p.lastActivity && (
                        <p style={{ fontSize: '0.75rem', color: '#16a34a' }}>
                          ÏôÑÎ£åÏùº: {new Date(p.lastActivity).toLocaleDateString()}
                        </p>
                      )}
                    </div>
                  );
                })}
              </div>
            );
          })()}
        </div>
      </div>

      {/* Îã§Ïùå ÏàòÏóÖ ÏùºÏ†ï */}
      {studentClasses.length > 0 && (
        <div className="card" style={{ marginTop: '2rem' }}>
          <div className="card-header">
            <div className="card-title">üìÖ Îã§Ïùå ÏàòÏóÖ</div>
          </div>
          <div className="card-body">
            <div style={{ display: 'flex', gap: '1rem', flexWrap: 'wrap' }}>
              {studentClasses.slice(0, 2).map((cls: any, index: number) => {
                const colors = [
                  { bg: '#dbeafe', border: '#bfdbfe', text: '#1e40af' },
                  { bg: '#dcfce7', border: '#bbf7d0', text: '#16a34a' }
                ];
                const color = colors[index % 2];
                const schedules = ['ÎÇ¥Ïùº 14:00', 'Î™©ÏöîÏùº 16:00', 'Í∏àÏöîÏùº 15:00', 'ÏàòÏöîÏùº 14:30'];
                
                return (
                  <div 
                    key={cls.id}
                    style={{ 
                      flex: 1, 
                      minWidth: '250px', 
                      padding: '1rem', 
                      background: color.bg, 
                      borderRadius: '0.5rem', 
                      border: `1px solid ${color.border}` 
                    }}
                  >
                    <div style={{ display: 'flex', alignItems: 'center', gap: '0.5rem', marginBottom: '0.75rem' }}>
                      <span style={{ fontSize: '1.25rem' }}>üïí</span>
                      <span style={{ fontWeight: '600', color: color.text }}>
                        {cls.schedule || schedules[index % 4]}
                      </span>
                    </div>
                    <h3 style={{ fontWeight: '600', marginBottom: '0.5rem' }}>{cls.name}</h3>
                    <p style={{ fontSize: '0.875rem', color: '#6b7280' }}>Îã§Ïùå ÏàòÏóÖ Ï§ÄÎπÑ</p>
                  </div>
                );
              })}
            </div>
          </div>
        </div>
      )}
    </div>
  );
};

export default StudentDashboard;