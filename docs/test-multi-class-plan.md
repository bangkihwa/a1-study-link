# 반/강의 관리 재설계 플랜

## 기존 문제 요약
- 관리자 화면(`frontend/src/components/admin/AcademyManagement.tsx:1`)은 과목과 반 폼을 한 페이지에 모두 노출하여 정보 밀도가 높고, 반 편성 시 학생 선택 영역이 화면 하단에 묻혀 가시성이 떨어짐.
- 반 학생 배정은 체크박스 기반으로 제공되지만, 필터/검색(`AcademyManagement.tsx:250`)은 단일 `select` + 텍스트 검색만 있어 200명 이상 학생을 다룰 때 스크롤과 수동 선택 부담이 큼.
- 백엔드 `ClassModel.setClassStudents`(`backend/src/models/classModel.ts:134`)는 일괄 삭제 후 삽입 방식이라 대규모 반 배정에서 변경량이 적어도 전체 레코드가 재작성됨. 변경 이력, 배정자 정보, 다중 반 배정 제약 등을 기록할 수단도 부족.
- 반과 강의(코스) 관리가 별도 화면에 분산되어 있어 운영자가 `과목 → 반 → 강의`를 오가며 현재 상태를 파악하기 어렵고, 주요 지표(배정 인원, 정원 대비 현황 등)가 즉시 노출되지 않음.

## 목표
1. 관리자 반 관리 화면에서 학생 배정/해제를 직관적으로 수행하고, 200명 이상 학생을 스트레스 없이 다룰 수 있는 UX 제공.
2. 과목/반/강의 관리의 맥락을 통합하여 학원 운영 흐름(과목 → 반 → 강의 → 시험/콘텐츠) 전체를 한 화면 안에서 파악.
3. 백엔드 API와 데이터 모델을 보완하여 대규모 배정과 변경 추적, 다중 반 편성 요구사항에 대응.
4. 기존 기능과의 호환성을 유지하면서 점진적으로 마이그레이션 가능한 설계 제공.

## 기능 요구사항
### 학생 배정/관리
- 반 선택 시 전담 "배정 관리 패널"을 열어 학생 목록, 현재 배정 현황, 다중 반 소속 여부를 즉시 표시.
- 필터 조건: `반`, `과목`, `학년`, `배정 상태(미배정·타 반 배정·현재 반 포함)` 조합 지원.
- 이름/이메일 실시간 검색, 키보드 내비게이션, 선택 항목 고정 영역 제공.
- `선택 전체`, `선택 해제`, `필터 결과 일괄 선택`, `선택 학생 다른 반에서 제거` 등 일괄 조작 UI 제공.
- 배정 변경 사항을 제출 전 미리보기(추가/삭제 카운트)로 표시해 실수 방지.

### 과목·반 통합 관리
- 상단 탭(과목, 반, 강의)으로 영역을 전환. 각 탭은 KPI 카드(예: 운영 중 반 수, 배정 학생 수, 미배정 강사 수)를 포함.
- 반 탭: 반 기본 정보 카드 + 학생 배정 패널 + 반 목록 테이블(정렬/필터/정원 대비 배정률 표시) 구성.
- 강의 탭: 반과 연결된 강의, 캘린더, 콘텐츠 현황을 빠르게 확인할 수 있는 요약 제공.

## 데이터 모델 및 API 변경 제안
1. `class_students` 테이블 확장
   - 컬럼 추가: `assigned_at`, `assigned_by`, `status('active'|'pending'|'dropped')`.
   - 인덱스: `(class_id, status)`, `(student_id, status)`로 필터링 최적화.
2. 변경 이력 테이블 신설 `class_student_history`
   - `id`, `class_id`, `student_id`, `action('assign'|'unassign')`, `triggered_by`, `notes`, `created_at`.
3. 새로운/보강 API
   - `GET /admin/classes/:id/students?status=&search=&subjectId=&grade=&includeHistory=`
   - `POST /admin/classes/:id/students/bulk` (추가/제거 목록, 보류 상태 설정 포함)
   - `GET /admin/students/assignable` 확장: `?subjectId=&classId=&unassignedOnly=`
   - `GET /admin/classes?includeMetrics=true` → `studentCount`, `capacityUsage`, `activeTests` 등 집계 포함.
4. 서비스 계층 개선
   - `AcademyService.setClassStudents`를 부분 갱신 방식으로 리팩터: 차집합 비교 후 추가/삭제만 수행.
   - 배정/해제 시 `NotificationService`가 학부모·학생 알림을 선택적으로 발송할 수 있도록 파라미터 추가.

## 프런트엔드 UX 설계안
1. `AcademyManagement` 리팩터링
   - 상태 `activeTab: 'subjects'|'classes'|'courses'` 추가, 탭 단위로 섹션 렌더.
   - 반 탭에서 `ClassAssignmentPanel`(신규 컴포넌트) 분리: 좌측 반 기본 폼, 우측 학생 배정.
   - 학생 리스트: 고정 높이 + `virtual-scroll`(예: `react-window`) 도입, 50명 이상일 때만 활성.
   - 필터, 검색, 요약 배너(`선택 n명 · 필터 m명 · 전체 k명`) 상단 노출.
   - 선택된 학생 칩(Chip) 형태로 상단에 표시, `X` 버튼으로 빠른 해제.
   - 제출 버튼은 변경 검증 후 활성화, 진행 중 로더 및 성공 피드백 토스트 노출.
2. 반 목록 테이블 개선
   - 컬럼: 반 이름, 과목, 강사, 학년, 정원/배정 수, 상태, 최근 업데이트, 관리(수정/학생배정/비활성).
   - 정렬/필터: 정원 대비 배정률, 과목, 강사, 상태.
   - 행 클릭 시 슬라이드 패널로 상세 정보/학생 목록 표시.
3. 강의 탭(향후 단계)
   - 반과 연결된 강의 카드, 캘린더 이벤트, 시험 배포 현황을 한눈에 보여주는 대시보드 구성.

## 대규모(200+ 학생) 대응 전략
- API: 학생 목록 요청 시 페이지네이션(`page`, `pageSize`) 및 서버 측 정렬/검색 적용.
- 프런트: 무한 스크롤 또는 페이지네이션, 가상 리스트, 검색 입력 디바운스(300ms) 적용.
- 네트워크: 배정 변경 시 낙관적 업데이트 + 실패 시 롤백 처리.
- 접근성: 키보드 포커스 순서, 스크린 리더 레이블, 선택 상태 ARIA 속성 보강.

## 구현 단계 제안
1. **설계 정밀화**: API 스펙 정의서 및 와이어프레임 작성 → 이해관계자 리뷰.
2. **백엔드 확장**
   - 마이그레이션 작성(`knex` 또는 SQL 스크립트) → `class_students`/`class_student_history`.
   - `AcademyService` 및 라우트(API) 리팩터링, 통합 테스트 추가.
3. **프런트엔드 리팩터링 1차**
   - `AcademyManagement` 탭 구조 및 레이아웃 재구성.
   - `ClassAssignmentPanel` 도입, 모듈화된 훅(`useClassAssignment`) 작성.
4. **프런트엔드 리팩터링 2차**
   - 가상 스크롤/페이지네이션 적용, 변경 요약/배정 통계 UI 연결.
   - 반 테이블 확장 + 상세 패널/모달 추가.
5. **연동 및 QA**
   - 시나리오 테스트: 대규모 학생 배정, 병행 편성, 다중 탭 이동.
   - 성능 측정: Lighthouse/React Profiler, API 응답 시간 로그.
6. **릴리스 & 모니터링**
   - 피쳐 플래그로 점진적 배포, 운영 피드백 수집 후 반복 개선.

## QA & 롤백 고려사항
- 롤백 시 새 컬럼/테이블 제거 스크립트 준비, API는 이전 버전 파라미터를 수용하도록 기간 내 호환 유지.
- 마이그레이션 후 데이터 검증: 반별 학생수, 배정 상태 불일치 여부 점검.
- UI 변경은 사용자 가이드/툴팁 제공, 초기 온보딩 레코딩 제작.
